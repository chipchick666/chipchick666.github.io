<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>魔卡少女樱 - 魔法商店</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>

    <script>
        // Tailwind 配置：自定义颜色和字体
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#F8A5C2', // 樱花粉 (主色调)
                        secondary: '#9B6AFA', // 魔法紫 (次色调)
                        accent: '#FFD700', // 金色 (强调色)
                        dark: '#574B90', // 深紫 (文字/深色背景)
                        light: '#FFEBF0' // 浅粉 (背景底色)
                    },
                    fontFamily: {
                        magic: ['Comic Sans MS', 'cursive', 'sans-serif']
                    }
                }
            }
        }
    </script>

    <style type="text/tailwindcss">
        @layer utilities {
            /* --- 公共组件样式 --- */
            /* 基础按钮样式 */
            .btn-base {
                @apply px-4 py-2 rounded-full transition-all transform hover:scale-105;
            }
            /* 导航栏按钮样式 */
            .nav-btn {
                @apply btn-base bg-primary/70 text-white hover:bg-secondary;
            }
            /* 激活状态的导航按钮 */
            .nav-btn.active {
                @apply bg-primary;
            }
            /* 卡片通用样式：圆角、阴影、悬停效果 */
            .card {
                @apply bg-white rounded-xl card-glow transform transition-all hover:shadow-lg;
            }
            /* 模态框内部容器样式 */
            .modal-inner {
                @apply bg-white rounded-2xl p-6 max-w-2xl w-full max-h-[80vh] overflow-y-auto transform transition-transform duration-300;
            }

            /* --- 特效样式 --- */
            .text-shadow {
                text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
            }
            .card-glow {
                box-shadow: 0 0 15px rgba(248, 165, 194, 0.6);
            }
            .magic-gradient {
                background: linear-gradient(135deg, #F8A5C2 0%, #9B6AFA 100%);
            }
            /* 背景图设置：固定背景、柔光混合模式 */
            .theme-blend-bg {
                background-image: url('https://i2.hdslb.com/bfs/new_dyn/9a30ed71ad4ac100c984d829e4f8c2903494361121687763.png@1192w.avif');
                background-size: cover;
                background-position: center;
                background-attachment: fixed;
                background-color: rgba(255, 235, 240, 0.75);
                background-blend-mode: soft-light;
            }
            
            /* --- 动画定义 --- */
            .float-animation {
                animation: float 6s ease-in-out infinite;
            }
            @keyframes float {
                0% { transform: translateY(0px); }
                50% { transform: translateY(-15px); }
                100% { transform: translateY(0px); }
            }
            .product-transition {
                transition: all 0.3s ease-in-out;
            }
            /* 购物车移除时的滑出动画 */
            .cart-item-remove {
                animation: slideOut 0.3s forwards;
            }
            @keyframes slideOut {
                0% { opacity: 1; transform: translateX(0); height: auto; margin: revert; padding: revert;}
                100% { opacity: 0; transform: translateX(20px); height: 0 !important; margin: 0 !important; padding: 0 !important;}
            }

            /* --- 新增样式：数量调整器 --- */
            .qty-btn {
                @apply w-8 h-8 flex items-center justify-center bg-gray-100 rounded-full hover:bg-primary hover:text-white transition-colors cursor-pointer font-bold;
            }
            .qty-input {
                @apply w-12 text-center bg-transparent font-bold text-dark focus:outline-none;
            }
            /* --- 音乐播放器专用样式 (液态玻璃风) --- */
            .glass-player {
                background: rgba(255, 255, 255, 0.2);
                backdrop-filter: blur(20px); /* 核心：磨砂玻璃模糊 */
                -webkit-backdrop-filter: blur(20px);
                border: 1px solid rgba(255, 255, 255, 0.5);
                box-shadow: 
                    0 8px 32px 0 rgba(31, 38, 135, 0.2),
                    inset 0 0 0 1px rgba(255, 255, 255, 0.2);
                border-radius: 24px;
                transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            }

            .glass-player:hover {
                background: rgba(255, 255, 255, 0.3);
                box-shadow: 
                    0 12px 40px 0 rgba(31, 38, 135, 0.3),
                    inset 0 0 20px rgba(255, 255, 255, 0.4);
                transform: translateY(2px);
            }

            /* 液态流体背景动画 */
            .liquid-bg {
                background: linear-gradient(45deg, #f3ec78, #af4261, #F8A5C2, #9B6AFA);
                background-size: 300% 300%;
                animation: liquidAnimate 8s ease infinite;
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
            }

            @keyframes liquidAnimate {
                0% { background-position: 0% 50%; }
                50% { background-position: 100% 50%; }
                100% { background-position: 0% 50%; }
            }

            /* 自定义进度条：看起来像液体 */
            .liquid-range {
                -webkit-appearance: none;
                width: 100%;
                height: 6px;
                background: rgba(255,255,255,0.3);
                border-radius: 10px;
                outline: none;
                overflow: hidden;
                cursor: pointer;
            }

            .liquid-range::-webkit-slider-thumb {
                -webkit-appearance: none;
                width: 0px; /* 隐藏滑块，只显示进度颜色 */
                height: 6px;
                box-shadow: -405px 0 0 400px #F8A5C2; /* 使用阴影作为进度填充 */
                cursor: pointer;
                transition: box-shadow 0.3s ease;
            }

            /* 唱片旋转动画 */
            .spin-record {
                animation: spin 6s linear infinite;
            }
            .spin-paused {
                animation-play-state: paused;
            }
            @keyframes spin {
                from { transform: rotate(0deg); }
                to { transform: rotate(360deg); }
            }
            /* --- 音乐播放器专用样式 (液态玻璃风) --- */
.glass-player {
    /* ... 保持原有的样式，如背景、模糊、阴影等 ... */
    background: rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(20px); 
    /* ... 其他样式 ... */
}

/* 核心：基于视口宽度的等比例缩放类 */
/* 播放器尺寸基准：宽 64vw (在小屏上会变小), 字体和内边距都用 vw */
.vw-scale {
    width: 64vw; /* 播放器宽度占视口宽度的 64% */
    max-width: 300px; /* 限制最大宽度，防止在超大屏幕上失控 */
    min-width: 200px; /* 限制最小宽度，防止在超小屏幕上太小 */
    padding: 2vw; /* 内边距也根据视口宽度缩放 */
    border-radius: 4vw;
}

/* 内部元素尺寸也要用 vw */
.vw-scale .record-icon {
    width: 10vw;
    height: 10vw;
    max-width: 40px;
    max-height: 40px;
    margin-right: 1.5vw;
}

.vw-scale .song-title {
    font-size: 3.5vw; /* 歌名也随屏幕宽度缩放 */
    line-height: 1.2;
}

.vw-scale .time-display {
    font-size: 2.5vw;
}

.vw-scale .control-btn {
    font-size: 4vw; /* 按钮图标尺寸 */
}

.vw-scale .play-btn {
    width: 8vw;
    height: 8vw;
    max-width: 32px;
    max-height: 32px;
}
/* ... 保持原有的其他 CSS 样式 ... */
            }
    </style>
</head>

<body class="font-magic theme-blend-bg min-h-screen overflow-x-hidden">
    <div id="magicMusicPlayer" class="fixed top-2 left-4 z-[100] glass-player p-2 w-72 select-none block">
        <div class="flex items-center mb-3">
            <div class="relative w-12 h-12 mr-3 flex-shrink-0">
                <div id="recordDisc"
                    class="w-full h-full rounded-full bg-gradient-to-tr from-gray-800 to-black border-2 border-white/30 shadow-lg flex items-center justify-center spin-record spin-paused">
                    <div class="w-4 h-4 bg-primary rounded-full border border-white"></div>
                </div>
                <i class="fa fa-music absolute -top-1 -right-1 text-accent text-xs animate-bounce"></i>
            </div>

            <div class="flex-1 overflow-hidden">
                <h4 id="songTitle"
                    class="text-dark font-bold text-base whitespace-nowrap overflow-hidden text-ellipsis liquid-bg">
                    等待播放音乐...
                </h4>
                <p id="timeDisplay" class="text-xs text-gray-600 font-medium mt-1">00:00 / 00:00</p>
            </div>
        </div>

        <div class="flex justify-between items-center mb-2 px-2">
            <button id="prevBtn" class="text-gray-600 hover:text-primary transition-colors transform hover:scale-110">
                <i class="fa fa-step-backward"></i>
            </button>
            <button id="playPauseBtn"
                class="w-10 h-10 rounded-full bg-white/40 flex items-center justify-center text-secondary hover:bg-white hover:text-primary hover:shadow-lg transition-all transform hover:scale-105 backdrop-blur-sm">
                <i class="fa fa-play ml-1" id="playIcon"></i>
            </button>
            <button id="nextBtn" class="text-gray-600 hover:text-primary transition-colors transform hover:scale-110">
                <i class="fa fa-step-forward"></i>
            </button>
        </div>

        <div class="relative w-full h-0">
            <input type="range" id="progressBar" value="0" max="100" class="liquid-range">
        </div>
    </div>
    <div id="particles-js" class="fixed top-0 left-0 w-full h-full z-0 opacity-70"></div>

    <div class="relative z-10 container mx-auto px-4 py-8">

        <header class="mb-10 text-center">
            <div class="flex flex-col items-center mb-6">
                <div
                    class="text-4xl md:text-5xl font-bold text-primary text-shadow mb-4 tracking-wide title-font float-animation">
                    <i class="fa fa-magic mr-2 text-accent"></i>小樱的魔法店铺
                </div>
                <div id="userInfo" class="hidden md:block self-end">
                    <span id="usernameDisplay" class="mr-4 text-dark font-bold"></span>
                    <button id="logoutBtn" class="bg-secondary text-white btn-base">
                        <i class="fa fa-sign-out mr-1"></i>退出
                    </button>
                </div>
            </div>

            <nav id="mainNav" class="hidden mb-8">
                <ul class="flex flex-wrap justify-center gap-4 md:gap-8">
                    <li><a href="#" class="nav-link nav-btn active" data-page="shopPage">商品商店</a></li>
                    <li><a href="#" class="nav-link nav-btn" data-page="cartPage">购物车</a></li>
                    <li><a href="#" class="nav-link nav-btn" data-page="paymentPage">支付订单</a></li>
                    <li><a href="#" class="nav-link nav-btn" data-page="usagePage">魔法交流</a></li>
                    <li><a href="#" class="nav-link nav-btn" data-page="profilePage">我的账户</a></li>
                </ul>
            </nav>
        </header>

        <section id="authPage" class="max-w-md mx-auto">
            <div class="card p-8 transform transition-all hover:scale-[1.02]">
                <div class="text-center mb-6">
                    <h2 class="text-3xl font-bold text-primary text-shadow">
                        <i class="fa fa-star text-accent mr-2"></i>魔法之门
                    </h2>
                    <p class="text-gray-600">请登录或注册以进入魔法商店</p>
                </div>

                <div id="loginForm">
                    <div class="mb-4">
                        <label class="block text-dark mb-2" for="loginUsername">用户名</label>
                        <input type="text" id="loginUsername"
                            class="w-full px-4 py-2 border border-primary rounded-lg focus:outline-none focus:ring-2 focus:ring-secondary transition-all"
                            placeholder="输入用户名">
                    </div>
                    <div class="mb-6">
                        <label class="block text-dark mb-2" for="loginPassword">密码</label>
                        <input type="password" id="loginPassword"
                            class="w-full px-4 py-2 border border-primary rounded-lg focus:outline-none focus:ring-2 focus:ring-secondary transition-all"
                            placeholder="输入密码">
                    </div>
                    <button id="loginBtn"
                        class="w-full magic-gradient text-white py-3 rounded-lg font-bold hover:opacity-90 transition-all transform hover:scale-[1.02] mb-4">
                        登录 <i class="fa fa-sign-in ml-1"></i>
                    </button>
                    <p class="text-center text-gray-600">
                        还没有账号？ <span id="showRegister"
                            class="text-secondary cursor-pointer hover:underline transition-all">立即注册</span>
                    </p>
                    <p class="text-center mt-4 text-gray-600">
                        管理员登录？ <span id="showAdminLogin"
                            class="text-dark cursor-pointer hover:underline transition-all">点击这里</span>
                    </p>
                </div>

                <div id="registerForm" class="hidden">
                    <div class="mb-4">
                        <label class="block text-dark mb-2" for="regUsername">用户名</label>
                        <input type="text" id="regUsername"
                            class="w-full px-4 py-2 border border-primary rounded-lg focus:outline-none focus:ring-2 focus:ring-secondary transition-all"
                            placeholder="创建用户名">
                    </div>
                    <div class="mb-4">
                        <label class="block text-dark mb-2" for="regPassword">密码</label>
                        <input type="password" id="regPassword"
                            class="w-full px-4 py-2 border border-primary rounded-lg focus:outline-none focus:ring-2 focus:ring-secondary transition-all"
                            placeholder="创建密码">
                    </div>
                    <div class="mb-6">
                        <label class="block text-dark mb-2" for="regEmail">邮箱</label>
                        <input type="email" id="regEmail"
                            class="w-full px-4 py-2 border border-primary rounded-lg focus:outline-none focus:ring-2 focus:ring-secondary transition-all"
                            placeholder="输入邮箱">
                    </div>
                    <button id="registerBtn"
                        class="w-full magic-gradient text-white py-3 rounded-lg font-bold hover:opacity-90 transition-all transform hover:scale-[1.02] mb-4">
                        注册 <i class="fa fa-user-plus ml-1"></i>
                    </button>
                    <p class="text-center text-gray-600">
                        已有账号？ <span id="showLogin"
                            class="text-secondary cursor-pointer hover:underline transition-all">返回登录</span>
                    </p>
                </div>

                <div id="adminLoginForm" class="hidden">
                    <div class="mb-4">
                        <label class="block text-dark mb-2" for="adminUsername">管理员账号</label>
                        <input type="text" id="adminUsername"
                            class="w-full px-4 py-2 border border-primary rounded-lg focus:outline-none focus:ring-2 focus:ring-secondary transition-all"
                            placeholder="管理员账号">
                    </div>
                    <div class="mb-6">
                        <label class="block text-dark mb-2" for="adminPassword">管理员密码</label>
                        <input type="password" id="adminPassword"
                            class="w-full px-4 py-2 border border-primary rounded-lg focus:outline-none focus:ring-2 focus:ring-secondary transition-all"
                            placeholder="管理员密码">
                    </div>
                    <button id="adminLoginBtn"
                        class="w-full magic-gradient text-white py-3 rounded-lg font-bold hover:opacity-90 transition-all transform hover:scale-[1.02] mb-4">
                        管理员登录 <i class="fa fa-lock ml-1"></i>
                    </button>
                    <p class="text-center text-gray-600">
                        返回用户登录？ <span id="showUserLogin"
                            class="text-secondary cursor-pointer hover:underline transition-all">点击这里</span>
                    </p>
                </div>
            </div>
        </section>

        <section id="adminPage" class="hidden">
            <div class="card mb-8 p-6">
                <h2 class="text-2xl font-bold text-primary mb-4">
                    <i class="fa fa-tachometer text-accent mr-2"></i>管理员控制台
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-primary/10 p-4 rounded-xl transform transition-all hover:scale-105">
                        <h3 class="font-bold text-dark mb-2">总用户数</h3>
                        <p id="totalUsers" class="text-3xl text-primary">0</p>
                    </div>
                    <div class="bg-secondary/10 p-4 rounded-xl transform transition-all hover:scale-105">
                        <h3 class="font-bold text-dark mb-2">总销售额</h3>
                        <p id="totalSales" class="text-3xl text-secondary">¥0</p>
                    </div>
                    <div class="bg-accent/10 p-4 rounded-xl transform transition-all hover:scale-105">
                        <h3 class="font-bold text-dark mb-2">总订单数</h3>
                        <p id="totalOrders" class="text-3xl text-dark">0</p>
                    </div>
                </div>
            </div>

            <div class="card mb-8 p-6">
                <h3 class="text-xl font-bold text-primary mb-4">
                    <i class="fa fa-bar-chart text-accent mr-2"></i>商品销售数据分析
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="p-3 rounded-xl bg-light/50">
                        <canvas id="productChart" height="250"></canvas>
                    </div>
                    <div class="p-3 rounded-xl bg-light/50">
                        <canvas id="categoryChart" height="250"></canvas>
                    </div>
                </div>
                <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-light p-4 rounded-xl transform transition-all hover:scale-105">
                        <h4 class="font-bold text-dark mb-2">人均消费金额</h4>
                        <p id="avgSpend" class="text-2xl text-primary">¥0</p>
                    </div>
                    <div class="bg-light p-4 rounded-xl transform transition-all hover:scale-105">
                        <h4 class="font-bold text-dark mb-2">平均购买次数</h4>
                        <p id="avgOrders" class="text-2xl text-secondary">0</p>
                    </div>
                </div>
            </div>

            <div class="card p-6">
                <h3 class="text-xl font-bold text-primary mb-4">
                    <i class="fa fa-users text-accent mr-2"></i>用户管理
                </h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full">
                        <thead>
                            <tr class="bg-primary/20">
                                <th class="py-3 px-4 text-left">用户名</th>
                                <th class="py-3 px-4 text-left">邮箱</th>
                                <th class="py-3 px-4 text-left">总订单</th>
                                <th class="py-3 px-4 text-left">总消费</th>
                                <th class="py-3 px-4 text-left">操作</th>
                            </tr>
                        </thead>
                        <tbody id="userTableBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card p-6 mt-8">
                <h3 class="text-xl font-bold text-primary mb-4">
                    <i class="fa fa-box-open text-accent mr-2"></i>商品管理
                </h3>
                <button id="addNewProductBtn" class="bg-secondary text-white btn-base mb-4">
                    <i class="fa fa-plus mr-1"></i> 上架新商品
                </button>
                <div class="overflow-x-auto">
                    <table class="min-w-full">
                        <thead>
                            <tr class="bg-primary/20">
                                <th class="py-3 px-4 text-left">商品名</th>
                                <th class="py-3 px-4 text-left">类别</th>
                                <th class="py-3 px-4 text-left">价格</th>
                                <th class="py-3 px-4 text-left">操作</th>
                            </tr>
                        </thead>
                        <tbody id="productTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <div id="userDetailModal"
            class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden opacity-0 transition-opacity duration-300">
            <div class="modal-inner scale-95">
                <div class="flex justify-between items-center mb-4">
                    <h4 class="text-xl font-bold text-primary" id="detailUsername">用户详情</h4>
                    <button class="close-modal-btn text-gray-500 hover:text-dark transition-colors"
                        data-modal="userDetailModal">
                        <i class="fa fa-times text-xl"></i>
                    </button>
                </div>
                <div class="mb-4">
                    <p><strong>邮箱:</strong> <span id="detailEmail"></span></p>
                    <p><strong>总订单数:</strong> <span id="detailTotalOrders"></span></p>
                    <p><strong>总消费金额:</strong> <span id="detailTotalSpend"></span></p>
                </div>
                <h5 class="font-bold text-dark mb-2">订单记录</h5>
                <div id="userOrdersList" class="space-y-3">
                </div>
                <div class="mt-4 flex justify-end">
                    <button id="clearUserOrders"
                        class="bg-secondary text-white px-4 py-2 rounded-lg mr-2 hover:bg-dark transition-all transform hover:scale-105">
                        清空所有记录
                    </button>
                    <button id="deleteUserAccount"
                        class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-all transform hover:scale-105">
                        删除此账号
                    </button>
                </div>
            </div>
        </div>

        <div id="addProductModal"
            class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden opacity-0 transition-opacity duration-300">
            <div class="modal-inner scale-95">
                <div class="flex justify-between items-center mb-4">
                    <h4 class="text-xl font-bold text-primary">上架新商品</h4>
                    <button class="close-modal-btn text-gray-500 hover:text-dark transition-colors"
                        data-modal="addProductModal">
                        <i class="fa fa-times text-xl"></i>
                    </button>
                </div>
                <div class="space-y-4">
                    <div>
                        <label class="block text-dark mb-2" for="newProductName">商品名</label>
                        <input type="text" id="newProductName"
                            class="w-full px-4 py-2 border border-primary rounded-lg focus:outline-none focus:ring-2 focus:ring-secondary transition-all"
                            placeholder="输入商品名">
                    </div>
                    <div>
                        <label class="block text-dark mb-2" for="newProductDesc">介绍</label>
                        <textarea id="newProductDesc"
                            class="w-full px-4 py-2 border border-primary rounded-lg focus:outline-none focus:ring-2 focus:ring-secondary transition-all"
                            placeholder="输入商品介绍"></textarea>
                    </div>
                    <div>
                        <label class="block text-dark mb-2" for="newProductImage">封面URL</label>
                        <input type="text" id="newProductImage"
                            class="w-full px-4 py-2 border border-primary rounded-lg focus:outline-none focus:ring-2 focus:ring-secondary transition-all"
                            placeholder="输入封面图片URL">
                    </div>
                    <div>
                        <label class="block text-dark mb-2" for="newProductPrice">价格</label>
                        <input type="number" id="newProductPrice" min="0"
                            class="w-full px-4 py-2 border border-primary rounded-lg focus:outline-none focus:ring-2 focus:ring-secondary transition-all"
                            placeholder="输入价格">
                    </div>
                    <div>
                        <label class="block text-dark mb-2" for="newProductCategory">类别</label>
                        <select id="newProductCategory"
                            class="w-full px-4 py-2 border border-primary rounded-lg focus:outline-none focus:ring-2 focus:ring-secondary transition-all">
                            <option value="音乐">音乐</option>
                            <option value="礼物">礼物</option>
                            <option value="疗法">疗法</option>
                            <option value="服饰">服饰</option>
                        </select>
                    </div>
                    <button id="submitNewProduct"
                        class="w-full magic-gradient text-white py-3 rounded-lg font-bold hover:opacity-90 transition-all transform hover:scale-[1.02]">
                        上架商品
                    </button>
                </div>
            </div>
        </div>

        <section id="shopPage" class="hidden">
            <h2 class="text-2xl font-bold text-primary mb-6 text-center">
                <i class="fa fa-shopping-bag text-accent mr-2"></i>魔法商品商店
            </h2>

            <div id="categoryContainer" class="mb-8 flex flex-wrap justify-center gap-4">
                <button class="category-btn nav-btn active" data-category="all">全部商品</button>
                <button class="category-btn nav-btn" data-category="音乐">音乐</button>
                <button class="category-btn nav-btn" data-category="礼物">礼物</button>
                <button class="category-btn nav-btn" data-category="疗法">疗法</button>
                <button class="category-btn nav-btn" data-category="服饰">服饰</button>
            </div>

            <div id="productList"
                class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            </div>
        </section>

        <div id="productDetailModal"
            class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden opacity-0 transition-opacity duration-300">
            <div class="modal-inner scale-95">
                <div class="flex justify-between items-center mb-4">
                    <h4 class="text-xl font-bold text-primary" id="productDetailTitle">商品详情</h4>
                    <button class="close-modal-btn text-gray-500 hover:text-dark transition-colors"
                        data-modal="productDetailModal">
                        <i class="fa fa-times text-xl"></i>
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="overflow-hidden rounded-xl">
                        <img id="productDetailImage" src="" alt="商品图片"
                            class="w-full h-auto rounded-xl transform transition-all hover:scale-105">
                    </div>
                    <div>
                        <div class="mb-4">
                            <p class="text-gray-600 mb-2"><strong>类别:</strong> <span id="productDetailCategory"></span>
                            </p>
                            <p class="text-2xl text-primary font-bold mb-4"><span id="productDetailPrice"></span></p>
                            <p class="text-gray-700 mb-6"><strong>介绍:</strong> <span id="productDetailDesc"></span></p>

                            <button id="addToCartFromDetail"
                                class="w-full bg-secondary text-white py-3 rounded-lg font-bold hover:bg-dark transition-all transform hover:scale-105">
                                <i class="fa fa-shopping-cart mr-1"></i> 加入购物车
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <section id="cartPage" class="hidden max-w-4xl mx-auto">
            <h2 class="text-2xl font-bold text-primary mb-6 text-center">
                <i class="fa fa-shopping-cart text-accent mr-2"></i>我的购物车
            </h2>

            <div id="emptyCart" class="text-center py-10 card">
                <img src="https://tse4-mm.cn.bing.net/th/id/OIP-C.8P_gxiucfd51bg9Z1bf5SwHaHa?w=215&h=215&c=7&r=0&o=7&dpr=1.5&pid=1.7&rm=3"
                    alt="空购物车" class="w-32 h-32 mx-auto mb-4 rounded-full">
                <p class="text-gray-600 mb-4">您的购物车还是空的哦~</p>
                <a href="#"
                    class="nav-link inline-block bg-primary text-white px-6 py-2 rounded-full hover:bg-secondary transition-all transform hover:scale-105"
                    data-page="shopPage">
                    去逛逛商品
                </a>
            </div>

            <div id="cartItems" class="hidden">
                <div class="card mb-6 p-6">
                    <ul id="cartList" class="space-y-4">
                    </ul>
                </div>

                <div class="card p-6">
                    <div class="flex justify-between items-center mb-4">
                        <span class="font-bold text-lg text-dark">总计:</span>
                        <span id="cartTotal" class="font-bold text-xl text-primary">¥0</span>
                    </div>
                    <button id="checkoutBtn"
                        class="w-full magic-gradient text-white py-3 rounded-lg font-bold hover:opacity-90 transition-all transform hover:scale-[1.02]">
                        前往结算 <i class="fa fa-arrow-right ml-1"></i>
                    </button>
                </div>
            </div>
        </section>

        <section id="paymentPage" class="hidden max-w-2xl mx-auto">
            <h2 class="text-2xl font-bold text-primary mb-6 text-center">
                <i class="fa fa-credit-card text-accent mr-2"></i>支付订单
            </h2>

            <div class="card mb-6 p-6">
                <h3 class="font-bold text-lg text-dark mb-4">订单详情</h3>
                <ul id="orderItems" class="space-y-2 mb-4"></ul>
                <div class="border-t border-gray-200 pt-4 flex justify-between font-bold">
                    <span>总计:</span>
                    <span id="orderTotal" class="text-primary text-xl">¥0</span>
                </div>
            </div>

            <div class="card p-6">
                <h3 class="font-bold text-lg text-dark mb-4">支付方式</h3>
                <div class="space-y-4 mb-6">
                    <label
                        class="flex items-center p-3 border border-gray-200 rounded-lg cursor-pointer hover:border-primary transition-all">
                        <input type="radio" name="paymentMethod" value="wechat" class="mr-3" checked>
                        <i class="fa fa-weixin text-green-500 text-xl mr-2"></i>
                        <span>微信支付</span>
                    </label>
                    <label
                        class="flex items-center p-3 border border-gray-200 rounded-lg cursor-pointer hover:border-primary transition-all">
                        <input type="radio" name="paymentMethod" value="alipay" class="mr-3">
                        <i class="fa fa-credit-card text-blue-500 text-xl mr-2"></i>
                        <span>支付宝</span>
                    </label>
                    <label
                        class="flex items-center p-3 border border-gray-200 rounded-lg cursor-pointer hover:border-primary transition-all">
                        <input type="radio" name="paymentMethod" value="card" class="mr-3">
                        <i class="fa fa-credit-card text-purple-500 text-xl mr-2"></i>
                        <span>银行卡支付</span>
                    </label>
                </div>
                <button id="payBtn"
                    class="w-full magic-gradient text-white py-3 rounded-lg font-bold hover:opacity-90 transition-all transform hover:scale-[1.02]">
                    确认支付 <i class="fa fa-check ml-1"></i>
                </button>
            </div>
        </section>

        <section id="usagePage" class="hidden max-w-4xl mx-auto">
            <h2 class="text-2xl font-bold text-primary mb-6 text-center">
                <i class="fa fa-comments text-accent mr-2"></i>魔法交流空间
            </h2>

            <div id="chatInterface">
                <div class="card overflow-hidden flex flex-col h-[600px]">
                    <div class="bg-primary text-white p-4">
                        <div class="flex items-center">
                            <img src="https://i0.hdslb.com/bfs/new_dyn/8d8c2812e465cebabcd70b266f0086173494361121687763.png@.webp"
                                alt="魔法助手" class="w-10 h-10 rounded-full mr-3">
                            <div>
                                <h3 class="font-bold">小樱魔法助手</h3>
                                <p class="text-sm opacity-80">在线 · 正在为您服务</p>
                            </div>
                        </div>
                    </div>

                    <div id="chatMessages" class="flex-1 p-4 overflow-y-auto space-y-4">
                        <div class="flex items-start">
                            <img src="https://i0.hdslb.com/bfs/new_dyn/8d8c2812e465cebabcd70b266f0086173494361121687763.png@.webp"
                                alt="魔法助手" class="w-8 h-8 rounded-full mr-2 mt-1">
                            <div class="bg-gray-100 rounded-lg rounded-tl-none px-4 py-2 max-w-[70%]">
                                <p>欢迎来到魔法交流空间！我是您的小樱魔法助手，有什么可以帮助您的吗？</p>
                            </div>
                        </div>
                    </div>

                    <div class="border-t p-4">
                        <div class="flex">
                            <input type="text" id="messageInput"
                                class="flex-1 px-4 py-2 border border-primary rounded-l-lg focus:outline-none focus:ring-2 focus:ring-secondary transition-all"
                                placeholder="输入您想交流的内容...">
                            <button id="sendMessage"
                                class="bg-primary text-white px-4 py-2 rounded-r-lg hover:bg-secondary transition-all transform hover:scale-105">
                                <i class="fa fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="profilePage" class="hidden max-w-2xl mx-auto">
            <h2 class="text-2xl font-bold text-primary mb-6 text-center">
                <i class="fa fa-user text-accent mr-2"></i>我的账户
            </h2>

            <div class="card mb-6 p-6">
                <h3 class="font-bold text-lg text-dark mb-4">个人信息</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-gray-600 mb-1">用户名</label>
                        <p id="profileUsername" class="font-medium"></p>
                    </div>
                    <div>
                        <label class="block text-gray-600 mb-1">邮箱</label>
                        <p id="profileEmail" class="font-medium"></p>
                    </div>
                    <div>
                        <label class="block text-gray-600 mb-1">注册时间</label>
                        <p id="profileRegTime" class="font-medium"></p>
                    </div>
                </div>
            </div>

            <div class="card p-6">
                <h3 class="font-bold text-lg text-dark mb-4">我的订单记录</h3>
                <div id="noOrders" class="text-center py-6">
                    <p class="text-gray-600">您还没有任何订单记录</p>
                </div>
                <div id="userOrders" class="space-y-4 hidden"></div>
            </div>
        </section>

        <div id="notificationModal"
            class="fixed bottom-3 right-4 z-[999] bg-white rounded-xl p-4 card-glow shadow-lg transform translate-x-full transition-transform duration-500  max-w-xs">
            <div class="flex items-start">
                <div id="notificationIcon" class="mr-3 text-xl"></div>
                <div>
                    <h4 id="notificationTitle" class="font-bold text-dark mb-1"></h4>
                    <p id="notificationMessage" class="text-gray-600 text-sm"></p>
                </div>
                <button id="closeNotification" class="ml-auto text-gray-400 hover:text-gray-600">
                    <i class="fa fa-times"></i>
                </button>
            </div>
        </div>

        <div id="paymentSuccessModal"
            class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden opacity-0 transition-opacity duration-300">
            <div
                class="bg-white rounded-2xl p-8 max-w-md w-full text-center transform scale-95 transition-transform duration-300">
                <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fa fa-check text-2xl text-green-500"></i>
                </div>
                <h3 class="text-2xl font-bold text-primary mb-2">支付成功！</h3>
                <p class="text-gray-600 mb-6">您的魔法订单已确认，感谢您的购买！</p>
                <button
                    class="close-modal-btn bg-primary text-white px-6 py-2 rounded-full hover:bg-secondary transition-all transform hover:scale-105"
                    data-modal="paymentSuccessModal" data-action="redirect-shop">
                    返回商店
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. 全局配置与状态 ---

        // 应用核心状态对象
        const appState = {
            currentUser: null, // 当前登录用户对象
            isAdmin: false,    // 是否为管理员权限
            // 从 localStorage 读取所有注册用户，若无则初始化空数组
            users: JSON.parse(localStorage.getItem('magicShopUsers')) || [],
            // 从 localStorage 读取购物车数据
            cart: JSON.parse(localStorage.getItem('magicShopCart')) || [],
            // 从 localStorage 读取商品数据，若无则初始化默认商品
            products: JSON.parse(localStorage.getItem('magicShopProducts')) || [
                { id: 'music1', name: '库洛牌主题曲', price: 30, category: '音乐', description: '百变小樱经典主题曲...', image: 'https://i0.hdslb.com/bfs/new_dyn/f5366ecb5e794799617709bd2a71f6e23494361121687763.png@.webp' },
                { id: 'music2', name: '魔卡变奏合集', price: 50, category: '音乐', description: '包含多种版本的魔卡变奏音乐...', image: 'https://i0.hdslb.com/bfs/new_dyn/88a6957192a1ac1b8545317683f083073494361121687763.png@.webp' },
                { id: 'gift1', name: '库洛牌套装', price: 120, category: '礼物', description: '精致的库洛牌收藏套装...', image: 'https://i0.hdslb.com/bfs/new_dyn/5442628c4e5e5b57a589a602491843a13494361121687763.png@.webp' },
                { id: 'gift2', name: '魔法棒模型', price: 99, category: '礼物', description: '小樱魔法棒1:1复刻模型...', image: 'https://i0.hdslb.com/bfs/new_dyn/b99d59a9027e6627e8e42c3e865408fd3494361121687763.png@.webp' },
                { id: 'therapy1', name: '心灵疗愈指导', price: 80, category: '疗法', description: '基于小樱精神的心灵疗愈...', image: 'https://i0.hdslb.com/bfs/new_dyn/3ae8aeff248eca89e1e490f92a67860a3494361121687763.png@.webp' },
                { id: 'therapy2', name: '冥想引导', price: 60, category: '疗法', description: '在魔法氛围中进行的冥想...', image: 'https://i0.hdslb.com/bfs/new_dyn/1003c80f5a65c6ee25f726623b18bc303494361121687763.png@.webp' },
                { id: 'clothes1', name: '小樱战斗服', price: 199, category: '服饰', description: '还原动画中小樱的经典战斗服装...', image: 'https://i0.hdslb.com/bfs/new_dyn/1794f4107d8c39ac602c52d489b0b15e3494361121687763.png@.webp' },
                { id: 'clothes2', name: '魔法少女斗篷', price: 159, category: '服饰', description: '精致的魔法斗篷...', image: 'https://i0.hdslb.com/bfs/new_dyn/6ed86fb50f58dcbeb715a4c36beded2a3494361121687763.png@.webp' },
            ],
            currentProductDetail: null // 当前正在查看详情的商品
        };

        // 缓存 DOM 元素，减少重复查询
        const domElements = {};
        let productChartInstance = null; // 销售图表实例
        let categoryChartInstance = null; // 分类图表实例

        // --- 2. 通用工具函数 ---

        /**
         * 保存所有用户信息到 localStorage
         */
        function saveUsersState() {
            localStorage.setItem('magicShopUsers', JSON.stringify(appState.users));
        }

        /**
         * 保存当前登录用户状态和购物车到 localStorage
         * 用于持久化数据，刷新页面不丢失
         */
        function saveCurrentUserState() {
            if (appState.currentUser) {
                localStorage.setItem('magicShopCurrentUser', JSON.stringify(appState.currentUser));
                saveUsersState(); // 同步更新总用户列表中的该用户数据
            }
            localStorage.setItem('magicShopCart', JSON.stringify(appState.cart));
        }

        /**
         * 保存商品数据到 localStorage
         */
        function saveProductsState() {
            localStorage.setItem('magicShopProducts', JSON.stringify(appState.products));
        }

        /**
         * 显示模态框 (带淡入和缩放动画)
         */
        function showModal(modalId) {
            const modalElement = document.getElementById(modalId);
            if (!modalElement) return;

            modalElement.classList.remove('hidden');
            setTimeout(() => {
                modalElement.classList.remove('opacity-0');
                const innerDiv = modalElement.querySelector('.modal-inner, div:not([id])');
                if (innerDiv) {
                    innerDiv.classList.remove('scale-95');
                    innerDiv.classList.add('scale-100');
                }
            }, 10);
        }

        /**
         * 隐藏模态框 (带淡出动画)
         */
        function hideModal(modalId) {
            const modalElement = document.getElementById(modalId);
            if (!modalElement) return;

            modalElement.classList.add('opacity-0');
            const innerDiv = modalElement.querySelector('.modal-inner, div:not([id])');
            if (innerDiv) {
                innerDiv.classList.remove('scale-100');
                innerDiv.classList.add('scale-95');
            }
            setTimeout(() => {
                modalElement.classList.add('hidden');
            }, 300);
        }

        // --- 3. 初始化逻辑 ---

        document.addEventListener('DOMContentLoaded', function () {
            // 初始化粒子特效背景
            particlesJS('particles-js', {
                "particles": {
                    "number": { "value": 80, "density": { "enable": true, "value_area": 800 } },
                    "color": { "value": ["#F8A5C2", "#9B6AFA", "#FFD700"] },
                    "shape": { "type": ["circle", "star"], "stroke": { "width": 0, "color": "#000000" } },
                    "opacity": { "value": 0.5, "random": true, "anim": { "enable": true, "speed": 1, "opacity_min": 0.1, "sync": false } },
                    "size": { "value": 5, "random": true, "anim": { "enable": true, "speed": 2, "size_min": 0.1, "sync": false } },
                    "line_linked": { "enable": false },
                    "move": { "enable": true, "speed": 1, "direction": "bottom", "random": true, "straight": false, "out_mode": "out", "bounce": false }
                },
                "interactivity": {
                    "detect_on": "canvas", "events": { "onhover": { "enable": true, "mode": "grab" }, "onclick": { "enable": true, "mode": "push" }, "resize": true },
                    "modes": { "grab": { "distance": 140, "line_linked": { "opacity": 0.5 } }, "push": { "particles_nb": 3 } }
                },
                "retina_detect": true
            });
            initApp();
            initMusicPlayer();
        });

        /**
         * 应用初始化入口
         * 绑定 DOM 元素、恢复用户登录状态、渲染初始界面
         */
        function initApp() {
            // 绑定主要 DOM 容器
            domElements.mainNav = document.getElementById('mainNav');
            domElements.userInfo = document.getElementById('userInfo');
            domElements.sections = document.querySelectorAll('section');
            domElements.productList = document.getElementById('productList');
            domElements.categoryContainer = document.getElementById('categoryContainer');
            domElements.cartList = document.getElementById('cartList');
            domElements.userTableBody = document.getElementById('userTableBody');
            domElements.userOrdersList = document.getElementById('userOrdersList');
            domElements.productTableBody = document.getElementById('productTableBody');

            // 尝试恢复登录状态
            const savedUser = localStorage.getItem('magicShopCurrentUser');
            const savedIsAdmin = localStorage.getItem('magicShopIsAdmin') === 'true';

            renderProducts(); // 渲染商品列表

            if (savedUser && savedIsAdmin) {
                // 恢复管理员会话
                appState.isAdmin = true;
                showPage('adminPage');
                updateAdminPage();
                setupUserInfoDisplay('管理员');
            } else if (savedUser) {
                // 恢复普通用户会话
                try {
                    appState.currentUser = JSON.parse(savedUser);
                    showPage('shopPage');
                    setupUserInfoDisplay(appState.currentUser.username);
                    updateCartDisplay();
                    updateProfilePage();
                    checkPurchasesForChat();
                } catch (e) {
                    // 若数据损坏，强制登出
                    localStorage.removeItem('magicShopCurrentUser');
                    showPage('authPage');
                    showNotification('数据错误', '用户数据损坏，请重新登录', 'error');
                }
            } else {
                // 未登录状态
                showPage('authPage');
            }

            setupEventListeners(); // 绑定所有事件
        }

        /**
         * 集中绑定所有事件监听器
         */
        function setupEventListeners() {
            // 登录/注册表单切换逻辑
            document.getElementById('showRegister').addEventListener('click', () => {
                document.getElementById('loginForm').classList.add('hidden');
                document.getElementById('registerForm').classList.remove('hidden');
                document.getElementById('adminLoginForm').classList.add('hidden');
            });
            document.getElementById('showLogin').addEventListener('click', () => {
                document.getElementById('loginForm').classList.remove('hidden');
                document.getElementById('registerForm').classList.add('hidden');
                document.getElementById('adminLoginForm').classList.add('hidden');
            });
            document.getElementById('showAdminLogin').addEventListener('click', () => {
                document.getElementById('loginForm').classList.add('hidden');
                document.getElementById('registerForm').classList.add('hidden');
                document.getElementById('adminLoginForm').classList.remove('hidden');
            });
            document.getElementById('showUserLogin').addEventListener('click', () => {
                document.getElementById('loginForm').classList.remove('hidden');
                document.getElementById('registerForm').classList.add('hidden');
                document.getElementById('adminLoginForm').classList.add('hidden');
            });

            // 认证按钮事件
            document.getElementById('loginBtn').addEventListener('click', handleLogin);
            document.getElementById('registerBtn').addEventListener('click', handleRegister);
            document.getElementById('adminLoginBtn').addEventListener('click', handleAdminLogin);
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);

            // 顶部导航栏点击事件 (单页应用路由切换)
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const pageId = link.getAttribute('data-page');
                    // 权限检查
                    if (!appState.currentUser && !appState.isAdmin && pageId !== 'authPage') {
                        showNotification('请先登录', '您需要登录才能使用此功能', 'warning');
                        return;
                    }
                    showPage(pageId);
                    updateNavActive(pageId);
                });
            });

            // 商品分类筛选 (事件委托)
            domElements.categoryContainer.addEventListener('click', (e) => {
                const btn = e.target.closest('.category-btn');
                if (btn) {
                    const category = btn.getAttribute('data-category');
                    // 更新按钮激活样式
                    document.querySelectorAll('.category-btn').forEach(b => {
                        b.classList.remove('active', 'bg-primary');
                        b.classList.add('bg-primary/70');
                    });
                    btn.classList.add('active', 'bg-primary');
                    btn.classList.remove('bg-primary/70');
                    filterProducts(category);
                }
            });

            // 商品列表点击事件：加入购物车 或 查看详情
            domElements.productList.addEventListener('click', (e) => {
                const cartBtn = e.target.closest('.add-to-cart');
                const productCard = e.target.closest('.product-card');
                // 忽略数量调整按钮的点击
                if (e.target.closest('.qty-adjust-shop') || e.target.closest('.item-quantity-input')) return;

                if (cartBtn) {
                    e.stopPropagation();
                    const productId = cartBtn.getAttribute('data-id');
                    let quantity = null;

                    const qtyInput = productCard.querySelector(`.item-quantity-input[data-id="${productId}"]`);
                    if (qtyInput) { quantity = qtyInput.value; }
                    addToCart(productId, false, quantity);

                } else if (productCard) {
                    // 点击卡片主体进入详情页
                    const productId = productCard.getAttribute('data-id');
                    showProductDetail(productId);
                }
            });

            // 商品列表页的数量加减
            domElements.productList.addEventListener('click', (e) => {
                const btn = e.target.closest('.qty-adjust-shop');
                if (btn) {
                    e.stopPropagation(); // 防止冒泡触发卡片详情
                    const action = btn.getAttribute('data-action');
                    const id = btn.getAttribute('data-id');
                    const input = document.querySelector(`.item-quantity-input[data-id="${id}"]`);

                    if (input) {
                        let val = parseInt(input.value) || 1;
                        if (action === 'plus') {
                            val++;
                        } else if (action === 'minus' && val > 1) {
                            val--;
                        }
                        input.value = val;
                    }
                }
            });

            // 购物车页面的数量加减与即时更新
            domElements.cartList.addEventListener('click', (e) => {
                const btn = e.target.closest('.cart-action-btn');
                if (btn) {
                    const action = btn.getAttribute('data-action');
                    const index = parseInt(btn.getAttribute('data-index'));

                    if (action === 'increase') {
                        appState.cart[index].quantity++;
                    } else if (action === 'decrease') {
                        if (appState.cart[index].quantity > 1) {
                            appState.cart[index].quantity--;
                        } else {
                            if (confirm('确定要移除该商品吗？')) {
                                removeFromCart(index, btn.closest('li'));
                                return;
                            }
                        }
                    }

                    // 重新计算该项总价并更新视图
                    appState.cart[index].totalPrice = appState.cart[index].quantity * appState.cart[index].price;
                    localStorage.setItem('magicShopCart', JSON.stringify(appState.cart));
                    updateCartDisplay();
                }
            });

            // 从详情页添加购物车
            document.getElementById('addToCartFromDetail').addEventListener('click', () => {
                if (appState.currentProductDetail) {
                    addToCart(appState.currentProductDetail.id, false);
                    hideModal('productDetailModal');
                }
            });

            // 结算与支付
            document.getElementById('checkoutBtn').addEventListener('click', () => {
                if (appState.cart.length === 0) {
                    showNotification('购物车为空', '请先添加商品到购物车', 'warning');
                    return;
                }
                populateOrderItems();
                showPage('paymentPage');
                updateNavActive('paymentPage');
            });
            document.getElementById('payBtn').addEventListener('click', handlePayment);

            // 聊天功能
            document.getElementById('sendMessage').addEventListener('click', sendChatMessage);
            document.getElementById('messageInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') { sendChatMessage(); }
            });

            // 关闭通知
            document.getElementById('closeNotification').addEventListener('click', hideNotification);

            // 购物车移除按钮 (垃圾桶图标)
            domElements.cartList.addEventListener('click', (e) => {
                const btn = e.target.closest('.remove-from-cart');
                if (btn) {
                    e.stopPropagation();
                    const index = parseInt(btn.getAttribute('data-index'));
                    removeFromCart(index, btn.closest('li'));
                }
            });

            // 管理员表格操作
            domElements.userTableBody.addEventListener('click', (e) => {
                const btn = e.target.closest('.view-user-details');
                if (btn) {
                    const username = btn.getAttribute('data-username');
                    showUserDetails(username);
                }
            });

            // 管理员删除用户订单
            domElements.userOrdersList.addEventListener('click', (e) => {
                const btn = e.target.closest('.delete-order');
                if (btn) {
                    const username = btn.getAttribute('data-username');
                    const orderId = btn.getAttribute('data-orderid');
                    deleteUserOrder(username, orderId);
                }
            });

            // 模态框操作按钮
            document.getElementById('clearUserOrders').addEventListener('click', clearUserOrders);
            document.getElementById('deleteUserAccount').addEventListener('click', deleteUserAccount);

            // 管理员添加新商品
            document.getElementById('addNewProductBtn')?.addEventListener('click', () => showModal('addProductModal'));
            document.getElementById('submitNewProduct')?.addEventListener('click', handleAddNewProduct);

            // 管理员下架商品
            domElements.productTableBody?.addEventListener('click', (e) => {
                const btn = e.target.closest('.remove-product');
                if (btn) {
                    const productId = btn.getAttribute('data-id');
                    removeProduct(productId);
                }
            });

            handleModalClicks(); // 初始化通用模态框关闭逻辑
        }

        function handleModalClicks() {
            // 关闭按钮点击
            document.querySelectorAll('.close-modal-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const modalId = btn.getAttribute('data-modal');
                    hideModal(modalId);
                    // 若是支付成功后的关闭，自动跳转回商店
                    if (btn.getAttribute('data-action') === 'redirect-shop') {
                        showPage('shopPage');
                        updateNavActive('shopPage');
                    }
                });
            });

            // ESC 键关闭
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    if (!document.getElementById('userDetailModal').classList.contains('hidden')) {
                        hideModal('userDetailModal');
                    } else if (!document.getElementById('productDetailModal').classList.contains('hidden')) {
                        hideModal('productDetailModal');
                    } else if (!document.getElementById('paymentSuccessModal').classList.contains('hidden')) {
                        hideModal('paymentSuccessModal');
                    } else if (!document.getElementById('addProductModal').classList.contains('hidden')) {
                        hideModal('addProductModal');
                    }
                }
            });
        }

        // --- 4. 渲染与视图逻辑 ---

        /**
         * 渲染商品列表
         * @param {string} filterCategory - 筛选分类 ('all' 为全部)
         */
        function renderProducts(filterCategory = 'all') {
            domElements.productList.innerHTML = '';

            appState.products.forEach(product => {
                if (filterCategory === 'all' || product.category === filterCategory) {
                    const productCard = document.createElement('div');

                    productCard.className = `product-card card overflow-hidden transform transition-all hover:scale-[1.03] cursor-pointer product-transition`;
                    productCard.setAttribute('data-category', product.category);
                    productCard.setAttribute('data-id', product.id);

                    const priceText = `¥${product.price}`;

                    // 普通商品：显示 +/- 数量选择器
                    let selectorHtml = `
                        <div class="flex justify-between items-center mb-4">
                            <span class="text-gray-600 text-sm">选择数量:</span>
                            <div class="flex items-center bg-gray-50 rounded-full px-2 py-1 border border-gray-200">
                                <button class="qty-adjust-shop text-gray-500 hover:text-primary px-2" data-action="minus" data-id="${product.id}">-</button>
                                <input type="number" min="1" value="1" class="item-quantity-input w-10 text-center bg-transparent text-sm font-bold" data-id="${product.id}" readonly>
                                <button class="qty-adjust-shop text-gray-500 hover:text-primary px-2" data-action="plus" data-id="${product.id}">+</button>
                            </div>
                        </div>
                    `;

                    productCard.innerHTML = `
                        <div class="h-48 overflow-hidden relative group">
                            <img src="${product.image}" alt="${product.name}" class="w-full h-full object-cover transition-all duration-500 group-hover:scale-110">
                            <div class="absolute inset-0 bg-black/20 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center text-white font-bold">
                                查看详情
                            </div>
                        </div>
                        <div class="p-4">
                            <div class="flex justify-between items-start mb-2">
                                <h3 class="font-bold text-lg text-dark truncate pr-2">${product.name}</h3>
                                <span class="bg-primary/10 text-primary text-sm px-2 py-1 rounded-full whitespace-nowrap font-bold">${priceText}</span>
                            </div>
                            ${selectorHtml}
                            <button class="add-to-cart w-full bg-secondary text-white py-2 rounded-lg hover:bg-dark transition-all transform hover:scale-105 shadow-md" data-id="${product.id}">
                                <i class="fa fa-shopping-cart mr-1"></i> 加入购物车
                            </button>
                        </div>
                    `;

                    domElements.productList.appendChild(productCard);
                }
            });
        }

        /**
         * 商品分类动画筛选
         */
        function filterProducts(category) {
            document.querySelectorAll('.product-card').forEach(card => {
                if (category === 'all' || card.getAttribute('data-category') === category) {
                    card.classList.remove('hidden', 'opacity-0', 'translate-y-4');
                } else {
                    card.classList.add('opacity-0', 'translate-y-4');
                    setTimeout(() => {
                        card.classList.add('hidden');
                    }, 300);
                }
            });
        }

        /**
         * 渲染管理员商品管理表格
         */
        function renderAdminProducts() {
            if (!domElements.productTableBody) return;

            domElements.productTableBody.innerHTML = '';

            appState.products.forEach(product => {
                const tr = document.createElement('tr');
                tr.className = 'border-b border-gray-200 hover:bg-light/30 transition-colors';

                tr.innerHTML = `
                    <td class="py-3 px-4">${product.name}</td>
                    <td class="py-3 px-4">${product.category}</td>
                    <td class="py-3 px-4">¥${product.price}</td>
                    <td class="py-3 px-4">
                        <button class="remove-product text-red-400 hover:text-red-600 transition-colors" data-id="${product.id}">
                            <i class="fa fa-trash mr-1"></i> 下架
                        </button>
                    </td>
                `;
                domElements.productTableBody.appendChild(tr);
            });
        }

        // --- 5. 核心业务逻辑 ---

        function showPage(pageId) {
            domElements.sections.forEach(section => {
                section.classList.add('hidden');
            });
            document.getElementById(pageId).classList.remove('hidden');

            // 登录页特殊处理：隐藏导航栏
            if (pageId === 'authPage') {
                domElements.mainNav.classList.add('hidden');
                domElements.userInfo.classList.add('hidden');
            } else {
                domElements.mainNav.classList.remove('hidden');
                domElements.userInfo.classList.remove('hidden');
            }
        }

        function updateNavActive(page) {
            document.querySelectorAll('.nav-link').forEach(link => {
                if (link.getAttribute('data-page') === page) {
                    link.classList.add('active');
                } else {
                    link.classList.remove('active');
                }
            });
        }

        function setupUserInfoDisplay(username) {
            document.getElementById('usernameDisplay').textContent = `欢迎，${username}！`;
        }

        // 登录处理
        function handleLogin() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value.trim();

            if (!username || !password) {
                showNotification('输入错误', '请输入用户名和密码', 'error');
                return;
            }
            const user = appState.users.find(u => u.username === username && u.password === password);

            if (user) {
                appState.currentUser = user;
                localStorage.setItem('magicShopCurrentUser', JSON.stringify(user));
                localStorage.setItem('magicShopIsAdmin', 'false');

                showPage('shopPage');
                setupUserInfoDisplay(user.username);
                updateNavActive('shopPage');
                updateCartDisplay();
                updateProfilePage();
                checkPurchasesForChat();
                showNotification('登录成功', `欢迎回来，${user.username}！`, 'success');

                document.getElementById('loginUsername').value = '';
                document.getElementById('loginPassword').value = '';
            } else {
                showNotification('登录失败', '用户名或密码错误', 'error');
            }
        }

        // 注册处理
        function handleRegister() {
            const username = document.getElementById('regUsername').value.trim();
            const password = document.getElementById('regPassword').value.trim();
            const email = document.getElementById('regEmail').value.trim();

            if (!username || !password || !email) {
                showNotification('输入错误', '请填写所有字段', 'error');
                return;
            }
            if (appState.users.some(u => u.username === username)) {
                showNotification('注册失败', '用户名已存在', 'error');
                return;
            }

            const newUser = {
                username,
                password,
                email,
                registerTime: new Date().toLocaleString(),
                orders: [],
                totalOrders: 0,
                totalSpend: 0
            };

            appState.users.push(newUser);
            saveUsersState();

            appState.currentUser = newUser;
            localStorage.setItem('magicShopCurrentUser', JSON.stringify(newUser));
            localStorage.setItem('magicShopIsAdmin', 'false');

            showPage('shopPage');
            setupUserInfoDisplay(newUser.username);
            updateNavActive('shopPage');
            updateProfilePage();

            showNotification('注册成功', '您已成功注册，欢迎来到魔法商店！', 'success');
            // 切换回登录表单视图
            document.getElementById('regUsername').value = '';
            document.getElementById('regPassword').value = '';
            document.getElementById('regEmail').value = '';
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('registerForm').classList.add('hidden');
        }

        // 管理员登录
        function handleAdminLogin() {
            const username = document.getElementById('adminUsername').value.trim();
            const password = document.getElementById('adminPassword').value.trim();

            if (username === 'Admin' && password === '123456') {
                appState.isAdmin = true;
                localStorage.setItem('magicShopIsAdmin', 'true');
                localStorage.setItem('magicShopCurrentUser', 'admin');

                showPage('adminPage');
                setupUserInfoDisplay('管理员');
                updateAdminPage();

                showNotification('管理员登录成功', '欢迎回来，管理员！', 'success');
                document.getElementById('adminUsername').value = '';
                document.getElementById('adminPassword').value = '';
            } else {
                showNotification('登录失败', '管理员账号或密码错误', 'error');
            }
        }

        function handleLogout() {
            appState.currentUser = null;
            appState.isAdmin = false;
            localStorage.removeItem('magicShopCurrentUser');
            localStorage.removeItem('magicShopIsAdmin');
            showPage('authPage');
            showNotification('已退出登录', '您已成功退出账号', 'info');
        }

        // 显示商品详情
        function showProductDetail(productId) {
            const product = appState.products.find(p => p.id === productId);
            if (!product) return;

            appState.currentProductDetail = product;

            document.getElementById('productDetailTitle').textContent = product.name;
            document.getElementById('productDetailImage').src = product.image;
            document.getElementById('productDetailImage').alt = product.name;
            document.getElementById('productDetailCategory').textContent = product.category;
            document.getElementById('productDetailPrice').textContent = `¥${product.price}`;
            document.getElementById('productDetailDesc').textContent = product.description;

            showModal('productDetailModal');
        }

        /**
         * 添加商品到购物车
         * @param {string} productId - 商品ID
         * @param {boolean} isTimeBased - 是否为时长商品
         * @param {number|null} inputQuantity - 指定的数量 (来自列表页输入框或详情页)
         */
        function addToCart(productId, isTimeBased = false, inputQuantity = null) {
            if (!appState.currentUser && !appState.isAdmin) {
                showNotification('请先登录', '您需要登录才能添加商品到购物车', 'warning');
                return;
            }

            const product = appState.products.find(p => p.id === productId);
            if (!product) return;

            // 获取数量逻辑
            let quantity = 1;
            if (inputQuantity !== null) {
                quantity = parseInt(inputQuantity);
            } else {
                const input = document.querySelector(`.item-quantity-input[data-id="${productId}"]`);
                if (input) {
                    quantity = parseInt(input.value);
                }
            }

            quantity = Math.max(1, isNaN(quantity) ? 1 : quantity);
            const totalPrice = product.price * quantity;

            // 检查购物车中是否已存在
            const existingItemIndex = appState.cart.findIndex(item => item.id === productId);

            if (existingItemIndex > -1) {
                // 更新现有项
                appState.cart[existingItemIndex].quantity += quantity;
                appState.cart[existingItemIndex].totalPrice = appState.cart[existingItemIndex].quantity * product.price;
            } else {
                // 新增项 (注意：这里保存了 image 字段，用于购物车显示)
                appState.cart.push({
                    id: product.id,
                    name: product.name,
                    price: product.price,
                    category: product.category,
                    quantity: quantity,
                    totalPrice: totalPrice,
                    timeBased: isTimeBased,
                    image: product.image
                });
            }

            localStorage.setItem('magicShopCart', JSON.stringify(appState.cart));
            updateCartDisplay();

            // 重置输入框
            const input = document.querySelector(`.item-quantity-input[data-id="${productId}"]`);
            if (input) input.value = 1;

            showNotification('添加成功', `${product.name} x${quantity} 已添加到购物车`, 'success');
        }

        function removeFromCart(index, listItem) {
            if (listItem) {
                listItem.classList.add('cart-item-remove'); // 添加移除动画类
                setTimeout(() => {
                    const removedItem = appState.cart.splice(index, 1)[0];
                    localStorage.setItem('magicShopCart', JSON.stringify(appState.cart));
                    updateCartDisplay();
                    showNotification('已移除', `${removedItem.name}已从购物车移除`, 'info');
                }, 300); // 等待动画结束
            }
        }

        /**
         * 更新购物车显示 (核心视图逻辑)
         * 包含了之前修复的图片显示和数量加减控件
         */
        function updateCartDisplay() {
            const cartList = document.getElementById('cartList');
            const cartTotal = document.getElementById('cartTotal');
            const emptyCart = document.getElementById('emptyCart');
            const cartItems = document.getElementById('cartItems');

            cartList.innerHTML = '';

            if (appState.cart.length === 0) {
                emptyCart.classList.remove('hidden');
                cartItems.classList.add('hidden');
                cartTotal.textContent = '¥0';
                return;
            }

            emptyCart.classList.add('hidden');
            cartItems.classList.remove('hidden');

            let total = 0;

            appState.cart.forEach((item, index) => {
                // 确保数值计算正确，修复了之前的字符串拼接问题
                item.totalPrice = item.quantity * item.price;
                // 强制转换为 Number 以确保计算安全
                total += Number(item.totalPrice);

                const li = document.createElement('li');
                li.className = 'flex items-center p-4 border-b border-gray-100 last:border-b-0 hover:bg-gray-50 transition-colors rounded-xl mb-2';
                li.setAttribute('data-index', index);

                // 购物车项 HTML 结构：左侧图片 + 中间信息 + 右侧数量控制/价格
                li.innerHTML = `
                    <div class="w-20 h-20 flex-shrink-0 rounded-lg overflow-hidden border border-gray-200 mr-4">
                        <img src="${item.image || 'https://via.placeholder.com/100'}" alt="${item.name}" class="w-full h-full object-cover">
                    </div>
                    
                    <div class="flex-1 min-w-0 mr-4">
                        <h4 class="font-bold text-dark text-lg truncate">${item.name}</h4>
                        <p class="text-sm text-gray-500 mb-1">${item.category}</p>
                        <p class="text-primary font-bold">¥${item.price} <span class="text-gray-400 text-xs font-normal">/件</span></p>
                    </div>

                    <div class="flex flex-col items-end space-y-2">
                        <div class="flex items-center bg-white border border-gray-200 rounded-full px-1 shadow-sm">
                            <button class="cart-action-btn w-8 h-8 flex items-center justify-center text-gray-500 hover:text-secondary transition-colors font-bold text-lg" data-action="decrease" data-index="${index}">-</button>
                            <span class="w-8 text-center font-bold text-dark text-sm">${item.quantity}</span>
                            <button class="cart-action-btn w-8 h-8 flex items-center justify-center text-gray-500 hover:text-secondary transition-colors font-bold text-lg" data-action="increase" data-index="${index}">+</button>
                        </div>
                        <div class="text-right">
                            <span class="block font-bold text-lg text-secondary">¥${item.totalPrice}</span>
                        </div>
                    </div>
                    
                    <button class="remove-from-cart ml-4 w-8 h-8 flex items-center justify-center text-gray-300 hover:text-red-500 transition-all transform hover:scale-110" data-index="${index}" title="删除">
                        <i class="fa fa-trash text-lg"></i>
                    </button>
                `;

                cartList.appendChild(li);
            });

            cartTotal.textContent = `¥${total}`;
        }

        // 生成结算页面的简单订单列表
        function populateOrderItems() {
            const orderItems = document.getElementById('orderItems');
            const orderTotal = document.getElementById('orderTotal');

            orderItems.innerHTML = '';
            let total = 0;

            appState.cart.forEach(item => {
                total += Number(item.totalPrice); // 显式转换

                const li = document.createElement('li');
                li.className = 'flex justify-between py-2 border-b border-gray-100 last:border-b-0';
                li.innerHTML = `
                    <span>${item.name} (${item.quantity}件)</span>
                    <span>¥${item.totalPrice}</span>
                `;
                orderItems.appendChild(li);
            });

            orderTotal.textContent = `¥${total}`;
        }

        /**
         * 处理支付逻辑
         */
        function handlePayment() {
            if (appState.cart.length === 0) {
                showNotification('订单为空', '请先添加商品到购物车', 'warning');
                return;
            }

            // 计算总金额 (使用 reduce 并强制转换为 Number 避免字符串拼接错误)
            const totalAmount = appState.cart.reduce((sum, item) => sum + Number(item.totalPrice), 0);

            // 生成模拟订单ID
            const generateUniqueId = () => {
                const timestamp = Date.now().toString(36);
                const randomStr = Math.random().toString(36).substr(2, 5);
                return `${timestamp}-${randomStr}`;
            };

            const order = {
                id: generateUniqueId(),
                items: [...appState.cart],
                totalAmount: totalAmount,
                date: new Date().toLocaleString(),
                paymentMethod: document.querySelector('input[name="paymentMethod"]:checked').value
            };

            // 更新用户信息
            appState.currentUser.orders.push(order);
            appState.currentUser.totalOrders = appState.currentUser.orders.length;
            appState.currentUser.totalSpend += totalAmount;

            saveCurrentUserState();

            // 清空购物车
            appState.cart = [];
            localStorage.setItem('magicShopCart', JSON.stringify(appState.cart));
            updateCartDisplay();

            updateProfilePage();
            checkPurchasesForChat();

            showModal('paymentSuccessModal');
        }

        function updateProfilePage() {
            if (!appState.currentUser) return;

            document.getElementById('profileUsername').textContent = appState.currentUser.username;
            document.getElementById('profileEmail').textContent = appState.currentUser.email;
            document.getElementById('profileRegTime').textContent = appState.currentUser.registerTime;

            const noOrders = document.getElementById('noOrders');
            const userOrders = document.getElementById('userOrders');

            userOrders.innerHTML = '';

            if (appState.currentUser.orders.length === 0) {
                noOrders.classList.remove('hidden');
                userOrders.classList.add('hidden');
                return;
            }

            noOrders.classList.add('hidden');
            userOrders.classList.remove('hidden');

            const sortedOrders = [...appState.currentUser.orders].sort((a, b) =>
                new Date(b.date) - new Date(a.date)
            );

            sortedOrders.forEach(order => {
                const orderDiv = document.createElement('div');
                orderDiv.className = 'p-4 border border-gray-100 rounded-lg hover:border-primary transition-colors';

                let itemsHtml = '';
                order.items.forEach(item => {
                    itemsHtml += `<li class="text-sm">${item.name} (${item.quantity}件) - ¥${item.totalPrice}</li>`;
                });

                orderDiv.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <h4 class="font-bold text-dark">订单 #${order.id.substring(0, 8)}</h4>
                        <span class="text-sm bg-green-100 text-green-800 px-2 py-1 rounded">已支付</span>
                    </div>
                    <p class="text-sm text-gray-600 mb-2">日期: ${order.date}</p>
                    <p class="text-sm text-gray-600 mb-2">支付方式: ${getPaymentMethodText(order.paymentMethod)}</p>
                    <p class="text-sm font-medium mb-1">商品:</p>
                    <ul class="ml-4 mb-2">
                        ${itemsHtml}
                    </ul>
                    <div class="flex justify-end font-bold text-primary">
                        总计: ¥${order.totalAmount}
                    </div>
                `;

                userOrders.appendChild(orderDiv);
            });
        }

        function getPaymentMethodText(method) {
            switch (method) {
                case 'wechat': return '微信支付';
                case 'alipay': return '支付宝';
                case 'card': return '银行卡支付';
                default: return '其他方式';
            }
        }

        // 检查是否有可用时长来启用聊天功能
        function checkPurchasesForChat() {
            if (!appState.currentUser) return;

            const noPurchases = document.getElementById('noPurchases');
            const chatInterface = document.getElementById('chatInterface');

            // 改为客服功能，直接可用
            if (noPurchases) noPurchases.classList.add('hidden');
            chatInterface.classList.remove('hidden');
        }

        // 发送聊天消息处理
        function sendChatMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();

            if (!message) return;

            const chatMessages = document.getElementById('chatMessages');

            // 渲染用户消息
            const userMessageDiv = document.createElement('div');
            userMessageDiv.className = 'flex items-start justify-end';
            userMessageDiv.innerHTML = `
                <div class="bg-primary text-white rounded-lg rounded-tr-none px-4 py-2 max-w-[70%]">
                    <p>${message}</p>
                </div>
                <img src="https://c-ssl.dtstatic.com/uploads/item/201810/31/20181031113745_vBthJ.thumb.1000_0.jpeg" alt="您" class="w-8 h-8 rounded-full ml-2 mt-1">
            `;

            chatMessages.appendChild(userMessageDiv);
            input.value = '';
            chatMessages.scrollTop = chatMessages.scrollHeight; // 滚动到底部

            // 模拟自动回复
            setTimeout(() => {
                const replies = [
                    "我明白了，很高兴能为您提供帮助！",
                    "这个问题很有趣，让我想想...",
                    "您的想法很棒呢！",
                    "关于这个，我可以给您一些建议...",
                    "感谢您的分享，我很乐意倾听。",
                    "这确实是个值得思考的问题。",
                    "您想了解更多关于哪方面的内容呢？"
                ];
                const randomReply = replies[Math.floor(Math.random() * replies.length)];

                const replyDiv = document.createElement('div');
                replyDiv.className = 'flex items-start';
                replyDiv.innerHTML = `
                    <img src="https://i0.hdslb.com/bfs/new_dyn/8d8c2812e465cebabcd70b266f0086173494361121687763.png@.webp" alt="魔法助手" class="w-8 h-8 rounded-full mr-2 mt-1">
                    <div class="bg-gray-100 rounded-lg rounded-tl-none px-4 py-2 max-w-[70%]">
                        <p>${randomReply}</p>
                    </div>
                `;

                chatMessages.appendChild(replyDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }, 1000);
        }

        // 更新管理员后台数据
        function updateAdminPage() {
            if (!appState.isAdmin) return;

            document.getElementById('totalUsers').textContent = appState.users.length;

            let totalSales = 0;
            let totalOrders = 0;

            appState.users.forEach(user => {
                totalSales += user.totalSpend;
                totalOrders += user.totalOrders;
            });

            document.getElementById('totalSales').textContent = `¥${totalSales}`;
            document.getElementById('totalOrders').textContent = totalOrders;

            const avgSpend = appState.users.length > 0 ? (totalSales / appState.users.length).toFixed(2) : 0;
            const avgOrders = appState.users.length > 0 ? (totalOrders / appState.users.length).toFixed(1) : 0;

            document.getElementById('avgSpend').textContent = `¥${avgSpend}`;
            document.getElementById('avgOrders').textContent = avgOrders;

            const userTableBody = domElements.userTableBody;
            userTableBody.innerHTML = '';

            appState.users.forEach(user => {
                const tr = document.createElement('tr');
                tr.className = 'border-b border-gray-200 hover:bg-light/30 transition-colors';

                tr.innerHTML = `
                    <td class="py-3 px-4">${user.username}</td>
                    <td class="py-3 px-4">${user.email}</td>
                    <td class="py-3 px-4">${user.totalOrders}</td>
                    <td class="py-3 px-4">¥${user.totalSpend}</td>
                    <td class="py-3 px-4">
                        <button class="view-user-details text-secondary hover:text-dark transition-colors" data-username="${user.username}">
                            <i class="fa fa-eye mr-1"></i> 查看详情
                        </button>
                    </td>
                `;
                userTableBody.appendChild(tr);
            });

            renderAdminProducts(); // 渲染商品管理表格

            updateCharts();
        }

        // 显示用户详细信息 (管理员功能)
        function showUserDetails(username) {
            const user = appState.users.find(u => u.username === username);
            if (!user) return;

            document.getElementById('detailUsername').textContent = `${user.username} 的详情`;
            document.getElementById('detailEmail').textContent = user.email;
            document.getElementById('detailTotalOrders').textContent = user.totalOrders;
            document.getElementById('detailTotalSpend').textContent = `¥${user.totalSpend}`;

            const ordersList = domElements.userOrdersList;
            ordersList.innerHTML = '';

            if (user.orders.length === 0) {
                ordersList.innerHTML = '<p class="text-gray-600">该用户没有订单记录</p>';
            } else {
                const sortedOrders = [...user.orders].sort((a, b) =>
                    new Date(b.date) - new Date(a.date)
                );

                sortedOrders.forEach(order => {
                    const orderDiv = document.createElement('div');
                    orderDiv.className = 'p-3 border border-gray-100 rounded-lg';

                    orderDiv.innerHTML = `
                        <div class="flex justify-between items-center mb-2">
                            <h5 class="font-bold text-dark">订单 #${order.id.substring(0, 8)}</h5>
                            <div class="flex items-center">
                                <span class="text-sm text-gray-600 mr-3">${order.date}</span>
                                <button class="delete-order text-red-400 hover:text-red-600 transition-colors" data-username="${user.username}" data-orderid="${order.id}">
                                    <i class="fa fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <p class="text-sm text-gray-600 mb-1">总金额: ¥${order.totalAmount}</p>
                    `;

                    ordersList.appendChild(orderDiv);
                });
            }

            document.getElementById('clearUserOrders').setAttribute('data-username', user.username);
            document.getElementById('deleteUserAccount').setAttribute('data-username', user.username);

            showModal('userDetailModal');
        }

        function deleteUserOrder(username, orderId) {
            const userIndex = appState.users.findIndex(u => u.username === username);
            if (userIndex === -1) return;

            const user = appState.users[userIndex];
            const orderIndex = user.orders.findIndex(o => o.id === orderId);

            if (orderIndex === -1) return;

            const deletedOrder = user.orders.splice(orderIndex, 1)[0];

            // 重新计算用户统计数据
            user.totalOrders = user.orders.length;
            user.totalSpend -= deletedOrder.totalAmount;

            saveUsersState();

            if (appState.currentUser && appState.currentUser.username === username) {
                localStorage.setItem('magicShopCurrentUser', JSON.stringify(user));
                updateProfilePage();
                checkPurchasesForChat();
            }

            updateAdminPage();
            showUserDetails(username);
            showNotification('订单已删除', '成功删除该订单记录', 'info');
        }

        function clearUserOrders() {
            const username = document.getElementById('clearUserOrders').getAttribute('data-username');
            if (!username) return;

            const userIndex = appState.users.findIndex(u => u.username === username);
            if (userIndex === -1) return;

            appState.users[userIndex].orders = [];
            appState.users[userIndex].totalOrders = 0;
            appState.users[userIndex].totalSpend = 0;

            saveUsersState();

            if (appState.currentUser && appState.currentUser.username === username) {
                localStorage.setItem('magicShopCurrentUser', JSON.stringify(appState.users[userIndex]));
                updateProfilePage();
                checkPurchasesForChat();
            }

            updateAdminPage();
            showUserDetails(username);
            showNotification('订单已清空', '成功清空该用户所有订单记录', 'info');
        }

        function deleteUserAccount() {
            const username = document.getElementById('deleteUserAccount').getAttribute('data-username');
            if (!username) return;

            if (confirm(`确定要删除用户 ${username} 的账号吗？此操作不可恢复。`)) {
                const userIndex = appState.users.findIndex(u => u.username === username);
                if (userIndex > -1) {
                    appState.users.splice(userIndex, 1);

                    saveUsersState();

                    if (appState.currentUser && appState.currentUser.username === username) {
                        handleLogout();
                    }

                    hideModal('userDetailModal');
                    updateAdminPage();
                    showNotification('账号已删除', `用户 ${username} 的账号已成功删除`, 'info');
                }
            }
        }

        // 更新后台图表
        function updateCharts() {
            const productSales = {};
            const categorySales = {};

            // 初始化计数器
            appState.products.forEach(product => {
                productSales[product.name] = 0;
                if (!categorySales[product.category]) { categorySales[product.category] = 0; }
            });

            // 遍历所有用户的订单计算销售额
            appState.users.forEach(user => {
                user.orders.forEach(order => {
                    order.items.forEach(item => {
                        if (productSales[item.name] !== undefined) { productSales[item.name] += item.totalPrice; }
                        if (categorySales[item.category] !== undefined) { categorySales[item.category] += item.totalPrice; }
                    });
                });
            });

            if (productChartInstance) { productChartInstance.destroy(); }
            if (categoryChartInstance) { categoryChartInstance.destroy(); }

            const productCtx = document.getElementById('productChart').getContext('2d');
            productChartInstance = new Chart(productCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(productSales),
                    datasets: [{
                        label: '销售额 (元)',
                        data: Object.values(productSales),
                        backgroundColor: 'rgba(248, 165, 194, 0.7)',
                        borderColor: 'rgba(248, 165, 194, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: { y: { beginAtZero: true } },
                    plugins: { legend: { display: false } }
                }
            });

            const categoryCtx = document.getElementById('categoryChart').getContext('2d');
            categoryChartInstance = new Chart(categoryCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(categorySales),
                    datasets: [{
                        data: Object.values(categorySales),
                        backgroundColor: [
                            'rgba(248, 165, 194, 0.7)', 'rgba(155, 106, 250, 0.7)', 'rgba(255, 215, 0, 0.7)',
                            'rgba(87, 75, 144, 0.7)', 'rgba(255, 235, 240, 0.7)'
                        ],
                        borderColor: [
                            'rgba(248, 165, 194, 1)', 'rgba(155, 106, 250, 1)', 'rgba(255, 215, 0, 1)',
                            'rgba(87, 75, 144, 1)', 'rgba(255, 235, 240, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'right' } }
                }
            });
        }

        // 全局通知系统
        function showNotification(title, message, type = 'info') {
            const modal = document.getElementById('notificationModal');
            const icon = document.getElementById('notificationIcon');
            const titleEl = document.getElementById('notificationTitle');
            const messageEl = document.getElementById('notificationMessage');

            switch (type) {
                case 'success': icon.className = 'fa fa-check-circle text-green-500'; break;
                case 'error': icon.className = 'fa fa-times-circle text-red-500'; break;
                case 'warning': icon.className = 'fa fa-exclamation-triangle text-yellow-500'; break;
                default: icon.className = 'fa fa-info-circle text-blue-500';
            }

            titleEl.textContent = title;
            messageEl.textContent = message;

            modal.classList.remove('translate-x-full'); // 滑入显示

            setTimeout(hideNotification, 3000); // 3秒后自动隐藏
        }

        function hideNotification() {
            const modal = document.getElementById('notificationModal');
            modal.classList.add('translate-x-full'); // 滑出隐藏
        }

        // 上架新商品处理
        function handleAddNewProduct() {
            const name = document.getElementById('newProductName').value.trim();
            const desc = document.getElementById('newProductDesc').value.trim();
            const image = document.getElementById('newProductImage').value.trim();
            const price = parseFloat(document.getElementById('newProductPrice').value);
            const category = document.getElementById('newProductCategory').value;

            if (!name || !desc || !image || isNaN(price) || price <= 0 || !category) {
                showNotification('输入错误', '请填写所有字段且价格必须为正数', 'error');
                return;
            }

            const generateUniqueId = () => {
                const timestamp = Date.now().toString(36);
                const randomStr = Math.random().toString(36).substr(2, 5);
                return `${timestamp}-${randomStr}`;
            };

            const newProduct = {
                id: generateUniqueId(),
                name,
                description: desc,
                image,
                price,
                category
            };

            appState.products.push(newProduct);
            saveProductsState();

            // 清空表单
            document.getElementById('newProductName').value = '';
            document.getElementById('newProductDesc').value = '';
            document.getElementById('newProductImage').value = '';
            document.getElementById('newProductPrice').value = '';
            document.getElementById('newProductCategory').value = '音乐';

            hideModal('addProductModal');
            renderAdminProducts();
            renderProducts();
            showNotification('上架成功', `商品 ${name} 已成功上架`, 'success');
        }

        // 下架商品
        function removeProduct(productId) {
            if (confirm('确定要下架该商品吗？')) {
                const index = appState.products.findIndex(p => p.id === productId);
                if (index > -1) {
                    appState.products.splice(index, 1);
                    saveProductsState();
                    renderAdminProducts();
                    renderProducts();
                    showNotification('下架成功', '商品已成功下架', 'info');
                }
            }
        }
        /**
 * 初始化液态玻璃音乐播放器
 */
        function initMusicPlayer() {
            const audio = new Audio();
            const playPauseBtn = document.getElementById('playPauseBtn');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const progressBar = document.getElementById('progressBar');
            const songTitle = document.getElementById('songTitle');
            const timeDisplay = document.getElementById('timeDisplay');
            const playIcon = document.getElementById('playIcon');
            const recordDisc = document.getElementById('recordDisc');

           const playlist = [
                { title: '愿与愁', 
                src: 'https://gitee.com/yangsangalter/music/raw/master/%E6%84%BF%E4%B8%8E%E6%84%81-%E6%9E%97%E4%BF%8A%E6%9D%B0.mp3' 
                }, // 歌名自定义

                { title: '不死之身', 
                src: ' https://gitee.com/yangsangalter/music/raw/master/%E4%B8%8D%E6%AD%BB%E4%B9%8B%E8%BA%AB-%E6%9E%97%E4%BF%8A%E6%9D%B0.mp3' 
                }, // 歌名自定义

                { title: '茉莉雨',
                 src: 'https://gitee.com/yangsangalter/music/raw/master/%E8%8C%89%E8%8E%89%E9%9B%A8-%E6%9E%97%E4%BF%8A%E6%9D%B0.mp3' 
                } // 歌名自定义
            ];
            let currentSongIndex = 0;
            let isPlaying = false;
            // 2. 加载歌曲
            function loadSong(index) {
                currentSongIndex = index;
                const song = playlist[currentSongIndex]; // 获取歌曲对象

                audio.src = song.src;
                songTitle.textContent = song.title; // 直接使用定义的 title

                //container.classList.remove('play');
                playPauseBtn.querySelector('i').className = 'fa fa-play';
                // 重置时间显示
                updateTimeDisplay(0, audio.duration);
            }

            // 3. 播放/暂停逻辑
            function playSong() {
                if (playlist.length === 0) return;
                audio.play().then(() => {
                    isPlaying = true;
                    updatePlayIcon();
                    recordDisc.classList.remove('spin-paused');
                    showNotification('正在播放', `🎵 ${playlist[currentSongIndex].title('/').pop()}`, 'info');
                }).catch(err => console.error("播放失败:", err));
            }

            function pauseSong() {
                audio.pause();
                isPlaying = false;
                updatePlayIcon();
                recordDisc.classList.add('spin-paused');
            }

            function togglePlay() {
                if (playlist.length === 0) return;
                if (isPlaying) {
                    pauseSong();
                } else {
                    playSong();
                }
            }

            function updatePlayIcon() {
                if (isPlaying) {
                    playIcon.className = 'fa fa-pause';
                } else {
                    playIcon.className = 'fa fa-play ml-1';
                }
            }

            // 4. 上一首/下一首
            prevBtn.addEventListener('click', () => {
                if (playlist.length === 0) return;
                let newIndex =currentSongIndex - 1;
                if (newIndex < 0) newIndex = playlist.length - 1; // 循环到最后一首
                loadSong(newIndex);
                playSong();
            });

            nextBtn.addEventListener('click', () => {
                playNextSong();
            });

            function playNextSong() {
                if (playlist.length === 0) return;
                let newIndex = currentSongIndex + 1;
                if (newIndex >= playlist.length) newIndex = 0; // 循环到第一首
                loadSong(newIndex);
                playSong();
            }

            // 5. 进度条与时间更新
            audio.addEventListener('timeupdate', (e) => {
                const { duration, currentTime } = e.srcElement;
                if (isNaN(duration)) return;

                const progressPercent = (currentTime / duration) * 100;
                progressBar.value = progressPercent;

                updateTimeDisplay(currentTime, duration);
            });

            // 歌曲结束后自动下一首
            audio.addEventListener('ended', playNextSong);

            // 拖动进度条
            progressBar.addEventListener('input', () => {
                const duration = audio.duration;
                if (!isNaN(duration)) {
                    audio.currentTime = (progressBar.value / 100) * duration;
                }
            });

            // 格式化时间
            function updateTimeDisplay(current, total) {
                const format = (time) => {
                    const min = Math.floor(time / 60);
                    const sec = Math.floor(time % 60);
                    return `${min}:${sec < 10 ? '0' + sec : sec}`;
                };
                timeDisplay.textContent = `${format(current)} / ${isNaN(total) ? '0:00' : format(total)}`;
            }

            // 按钮绑定
            playPauseBtn.addEventListener('click', togglePlay);
            loadSong(0);
        }
        
    </script>
</body>

</html>
